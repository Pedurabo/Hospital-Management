{% extends "base_dark.html" %}

{% block title %}My Appointments - Doctor Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card gradient-card animate__animated animate__fadeInUp">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1 text-white">
                                <i class="fas fa-calendar-alt me-2"></i>My Appointments
                            </h2>
                            <p class="mb-0 text-light opacity-75">Manage your patient appointments</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a href="{{ url_for('doctor_dashboard') }}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Filter Appointments</h6>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <div class="form-floating">
                                <input type="date" class="form-control glass-input" id="date" name="date" value="{{ date_filter }}">
                                <label for="date" class="text-muted">Date</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <select class="form-select glass-input" id="status" name="status">
                                    <option value="">All Status</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="no-show">No Show</option>
                                </select>
                                <label for="status" class="text-muted">Status</label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-floating">
                                <select class="form-select glass-input" id="type" name="type">
                                    <option value="">All Types</option>
                                    <option value="consultation">Consultation</option>
                                    <option value="follow-up">Follow-up</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="routine">Routine</option>
                                </select>
                                <label for="type" class="text-muted">Type</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-floating">
                                <button type="submit" class="btn btn-primary gradient-btn w-100 h-100">
                                    <i class="fas fa-filter me-1"></i>Filter
                                </button>
                            </div>
                        </div>
                    </form>
                    {% if date_filter or request.args.get('status') or request.args.get('type') %}
                        <div class="mt-3">
                            <a href="{{ url_for('doctor_appointments') }}" class="btn btn-outline-light btn-sm">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Appointments Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        Appointments ({{ appointments|length }})
                    </h6>
                    <div>
                        <button class="btn btn-success btn-sm gradient-btn" onclick="exportAppointments()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if appointments %}
                        <div class="table-responsive">
                            <table class="table table-dark table-hover" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Patient</th>
                                <th>Type</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for appointment in appointments %}
                            <tr>
                                <td>
                                    <div>
                                        <strong>{{ appointment.appointment_date.strftime('%Y-%m-%d') }}</strong><br>
                                        <span class="text-muted">{{ appointment.appointment_time.strftime('%H:%M') }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ appointment.patient_name }}</strong><br>
                                        <small class="text-muted">{{ appointment.phone_number }}</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ appointment.appointment_type }}</span>
                                </td>
                                <td>
                                    {% if appointment.reason %}
                                        <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ appointment.reason }}">
                                            {{ appointment.reason }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No reason provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if appointment.status == 'scheduled' %}
                                        <span class="badge bg-warning">Scheduled</span>
                                    {% elif appointment.status == 'completed' %}
                                        <span class="badge bg-success">Completed</span>
                                    {% elif appointment.status == 'cancelled' %}
                                        <span class="badge bg-danger">Cancelled</span>
                                    {% elif appointment.status == 'no-show' %}
                                        <span class="badge bg-secondary">No Show</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ appointment.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if appointment.notes %}
                                        <span class="text-truncate d-inline-block" style="max-width: 150px;" title="{{ appointment.notes }}">
                                            {{ appointment.notes }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No notes</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-primary" 
                                                onclick="viewAppointment({{ appointment.id }}, '{{ appointment.appointment_date }}', '{{ appointment.appointment_time }}', '{{ appointment.patient_name }}', '{{ appointment.phone_number }}', '{{ appointment.appointment_type }}', '{{ appointment.reason }}', '{{ appointment.status }}', '{{ appointment.notes or '' }}')"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" 
                                                onclick="editAppointment({{ appointment.id }})"
                                                title="Edit Appointment">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <a href="{{ url_for('doctor_patient_details', patient_id=appointment.patient_id) }}" 
                                           class="btn btn-sm btn-info"
                                           title="View Patient">
                                            <i class="fas fa-user"></i>
                                        </a>
                                        <a href="{{ url_for('doctor_patient_followup', patient_id=appointment.patient_id) }}?appointment_id={{ appointment.id }}&appointment_date={{ appointment.appointment_date }}&appointment_time={{ appointment.appointment_time }}&appointment_type={{ appointment.appointment_type }}&reason={{ appointment.reason }}" 
                                           class="btn btn-sm btn-success"
                                           title="Add Followup">
                                            <i class="fas fa-calendar-plus"></i>
                                        </a>
                                        <button class="btn btn-sm btn-dark" 
                                                onclick="alert('Testing button click for {{ appointment.patient_name }}'); console.log('Button clicked for patient:', {{ appointment.patient_id }}, '{{ appointment.patient_name }}'); openPrescriptionModal({{ appointment.patient_id }}, '{{ appointment.patient_name }}')"
                                                title="Create & Send Prescription to Pharmacist">
                                            <i class="fas fa-pills"></i>
                                        </button>
                                        {% if appointment.status == 'scheduled' %}
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="cancelAppointment({{ appointment.id }}, '{{ appointment.patient_name }}', '{{ appointment.appointment_date }}', '{{ appointment.appointment_time }}')"
                                                title="Cancel Appointment">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Appointments Found</h4>
                    <p class="text-muted">
                        {% if date_filter %}
                            No appointments found for {{ date_filter }}.
                        {% else %}
                            You don't have any appointments scheduled yet.
                        {% endif %}
                    </p>
                    <a href="{{ url_for('doctor_dashboard') }}" class="btn btn-primary gradient-btn">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
            {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Appointment Modal -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Update Appointment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateAppointmentForm" method="POST">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-floating">
                                    <select class="form-select glass-input" id="appointmentStatus" name="status" required>
                                        <option value="scheduled">Scheduled</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="no-show">No Show</option>
                                    </select>
                                    <label for="appointmentStatus" class="text-muted">Status</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="date" class="form-control glass-input" id="appointmentDate" readonly>
                                    <label for="appointmentDate" class="text-muted">Date</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="time" class="form-control glass-input" id="appointmentTime" readonly>
                                    <label for="appointmentTime" class="text-muted">Time</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control glass-input" id="patientName" readonly>
                                    <label for="patientName" class="text-muted">Patient</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-floating">
                            <textarea class="form-control glass-input" id="appointmentNotes" name="notes" rows="4" 
                                      placeholder="Enter appointment notes..."></textarea>
                            <label for="appointmentNotes" class="text-muted">Notes</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary gradient-btn">Update Appointment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Appointment Modal -->
<div class="modal fade" id="viewAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Appointment Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="appointmentDetails">
                    <!-- Details will be loaded here -->
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Appointment Modal -->
<div class="modal fade" id="cancelAppointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>Cancel Appointment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this appointment?</p>
                <div class="alert alert-warning glass-alert">
                    <strong>Appointment Details:</strong><br>
                    <span id="cancelAppointmentDetails"></span>
                </div>
                <div class="mb-3">
                    <div class="form-floating">
                        <textarea class="form-control glass-input" id="cancelReason" rows="3" 
                                  placeholder="Please provide a reason for cancellation..."></textarea>
                        <label for="cancelReason" class="text-muted">Cancellation Reason (Optional)</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Keep Appointment</button>
                <button type="button" class="btn btn-danger gradient-btn" onclick="confirmCancelAppointment()">
                    <i class="fas fa-times me-1"></i>Cancel Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Prescription Form Modal -->
<div class="modal fade" id="prescriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">
                    <i class="fas fa-pills text-primary me-2"></i>Create & Send Prescription
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="prescriptionForm">
                <div class="modal-body">
                    <div class="alert alert-info glass-alert">
                        <strong>Patient:</strong> <span id="prescriptionPatientName"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control glass-input" id="medication_name" name="medication_name" placeholder="Medication Name" required>
                                    <label for="medication_name" class="text-muted">Medication Name *</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control glass-input" id="dosage" name="dosage" placeholder="e.g., 500mg" required>
                                    <label for="dosage" class="text-muted">Dosage *</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-floating">
                                    <select class="form-select glass-input" id="frequency" name="frequency" required>
                                        <option value="">Select frequency</option>
                                        <option value="Once daily">Once daily</option>
                                        <option value="Twice daily">Twice daily</option>
                                        <option value="Three times daily">Three times daily</option>
                                        <option value="Four times daily">Four times daily</option>
                                        <option value="As needed">As needed</option>
                                        <option value="Before meals">Before meals</option>
                                        <option value="After meals">After meals</option>
                                        <option value="At bedtime">At bedtime</option>
                                    </select>
                                    <label for="frequency" class="text-muted">Frequency *</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control glass-input" id="duration" name="duration" placeholder="e.g., 7 days, 2 weeks">
                                    <label for="duration" class="text-muted">Duration</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-floating">
                                    <input type="date" class="form-control glass-input" id="prescribed_date" name="prescribed_date" required>
                                    <label for="prescribed_date" class="text-muted">Date Prescribed *</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-floating">
                                    <textarea class="form-control glass-input" id="instructions" name="instructions" rows="3" placeholder="Special instructions, side effects to watch for..."></textarea>
                                    <label for="instructions" class="text-muted">Special Instructions</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary gradient-btn">
                        <i class="fas fa-paper-plane me-1"></i>Create & Send to Pharmacist
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentAppointmentId = null;
let appointmentToCancel = null;

function editAppointment(appointmentId) {
    currentAppointmentId = appointmentId;
    
    // Get appointment data from the table row
    const row = event.target.closest('tr');
    const cells = row.cells;
    
    // Populate modal fields
    document.getElementById('appointmentDate').value = cells[0].querySelector('strong').textContent;
    document.getElementById('appointmentTime').value = cells[0].querySelector('.text-muted').textContent;
    document.getElementById('patientName').value = cells[1].querySelector('strong').textContent;
    document.getElementById('appointmentStatus').value = getStatusFromBadge(cells[4].querySelector('.badge').textContent);
    document.getElementById('appointmentNotes').value = cells[5].textContent.trim();
    
    // Update form action
    document.getElementById('updateAppointmentForm').action = `/doctor_update_appointment/${appointmentId}`;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('editAppointmentModal')).show();
}

function getStatusFromBadge(badgeText) {
    if (badgeText.includes('Scheduled')) return 'scheduled';
    if (badgeText.includes('Completed')) return 'completed';
    if (badgeText.includes('Cancelled')) return 'cancelled';
    if (badgeText.includes('No Show')) return 'no-show';
    return 'scheduled';
}

function viewAppointment(appointmentId, date, time, patientName, phoneNumber, type, reason, status, notes) {
    // Create detailed appointment information
    const statusBadge = getStatusBadge(status);
    const notesText = notes || 'No notes available';
    
    document.getElementById('appointmentDetails').innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary">
                            <i class="fas fa-calendar-alt me-2"></i>Appointment Information
                        </h6>
                        <div class="mb-2">
                            <strong>Date:</strong> ${date}
                        </div>
                        <div class="mb-2">
                            <strong>Time:</strong> ${time}
                        </div>
                        <div class="mb-2">
                            <strong>Type:</strong> ${type}
                        </div>
                        <div class="mb-2">
                            <strong>Status:</strong> ${statusBadge}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary">
                            <i class="fas fa-user me-2"></i>Patient Information
                        </h6>
                        <div class="mb-2">
                            <strong>Name:</strong> ${patientName}
                        </div>
                        <div class="mb-2">
                            <strong>Phone:</strong> ${phoneNumber}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-primary">
                            <i class="fas fa-sticky-note me-2"></i>Reason & Notes
                        </h6>
                        <div class="mb-2">
                            <strong>Reason:</strong> ${reason || 'No reason provided'}
                        </div>
                        <div class="mb-2">
                            <strong>Notes:</strong> ${notesText}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('viewAppointmentModal')).show();
}

function getStatusBadge(status) {
    const statusMap = {
        'scheduled': '<span class="badge bg-primary">Scheduled</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'cancelled': '<span class="badge bg-danger">Cancelled</span>',
        'no-show': '<span class="badge bg-warning">No Show</span>'
    };
    return statusMap[status] || '<span class="badge bg-secondary">Unknown</span>';
}

function cancelAppointment(appointmentId, patientName, date, time) {
    appointmentToCancel = appointmentId;
    
    // Display appointment details in the modal
    document.getElementById('cancelAppointmentDetails').innerHTML = `
        <strong>Patient:</strong> ${patientName}<br>
        <strong>Date:</strong> ${date}<br>
        <strong>Time:</strong> ${time}
    `;
    
    // Clear previous reason
    document.getElementById('cancelReason').value = '';
    
    // Show modal
    new bootstrap.Modal(document.getElementById('cancelAppointmentModal')).show();
}

function confirmCancelAppointment() {
    if (!appointmentToCancel) return;
    
    const reason = document.getElementById('cancelReason').value;
    
    // Send cancellation request
    fetch(`/doctor_cancel_appointment/${appointmentToCancel}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('cancelAppointmentModal')).hide();
            
            // Show success message
            showAlert('Appointment cancelled successfully!', 'success');
            
            // Reload page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showAlert('Failed to cancel appointment: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while cancelling the appointment.', 'danger');
    });
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

let currentPatientId = null;
let currentPatientName = null;

function openPrescriptionModal(patientId, patientName) {
    console.log('openPrescriptionModal called with:', patientId, patientName);
    
    currentPatientId = patientId;
    currentPatientName = patientName;
    
    // Set patient name in modal
    const patientNameElement = document.getElementById('prescriptionPatientName');
    if (patientNameElement) {
        patientNameElement.textContent = patientName;
        console.log('Patient name set:', patientName);
    } else {
        console.error('Patient name element not found');
    }
    
    // Set today's date as default
    const dateElement = document.getElementById('prescribed_date');
    if (dateElement) {
        dateElement.value = new Date().toISOString().split('T')[0];
        console.log('Date set to today');
    } else {
        console.error('Date element not found');
    }
    
    // Clear form
    const form = document.getElementById('prescriptionForm');
    if (form) {
        form.reset();
        console.log('Form reset');
    } else {
        console.error('Form not found');
    }
    
    // Show modal
    const modal = document.getElementById('prescriptionModal');
    if (modal) {
        const bootstrapModal = new bootstrap.Modal(modal);
        bootstrapModal.show();
        console.log('Modal shown successfully');
        
        // Additional debugging - check if form elements are accessible
        setTimeout(() => {
            console.log('Form elements check:');
            console.log('Medication name field:', document.getElementById('medication_name'));
            console.log('Dosage field:', document.getElementById('dosage'));
            console.log('Frequency field:', document.getElementById('frequency'));
            console.log('Form submit button:', document.querySelector('#prescriptionForm button[type="submit"]'));
        }, 100);
    } else {
        console.error('Modal not found');
    }
}

function sendPrescriptionToPharmacist(patientId, patientName) {
    if (!confirm(`Send the latest prescription for ${patientName} to the pharmacist?`)) return;
    
    fetch(`/send_prescription_to_pharmacist/${patientId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Prescription sent to pharmacist successfully!', 'success');
        } else {
            showAlert('Failed to send prescription: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while sending prescription.', 'danger');
    });
}

function exportAppointments() {
    // Create CSV content
    const table = document.querySelector('table');
    const rows = table.querySelectorAll('tbody tr');
    let csv = 'Date,Time,Patient,Phone,Type,Reason,Status,Notes\n';
    
    rows.forEach(row => {
        const cells = row.cells;
        const date = cells[0].querySelector('strong').textContent;
        const time = cells[0].querySelector('.text-muted').textContent;
        const patient = cells[1].querySelector('strong').textContent;
        const phone = cells[1].querySelector('.text-muted').textContent;
        const type = cells[2].textContent;
        const reason = cells[3].textContent.trim();
        const status = cells[4].textContent;
        const notes = cells[5].textContent.trim();
        
        csv += `"${date}","${time}","${patient}","${phone}","${type}","${reason}","${status}","${notes}"\n`;
    });
    
    // Download CSV file
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'appointments.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Handle prescription form submission
document.addEventListener('DOMContentLoaded', function() {
    const prescriptionForm = document.getElementById('prescriptionForm');
    if (prescriptionForm) {
        prescriptionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Prescription form submitted');
            console.log('Current patient ID:', currentPatientId);
            console.log('Current patient name:', currentPatientName);
            
            if (!currentPatientId) {
                showAlert('Error: Patient ID not found', 'danger');
                return;
            }
            
            const formData = new FormData(this);
            
            // Log form data for debugging
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            console.log('Sending request to:', `/create_and_send_prescription/${currentPatientId}`);
            
            fetch(`/create_and_send_prescription/${currentPatientId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('prescriptionModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Show success message
                    showAlert('Prescription created and sent to pharmacist successfully!', 'success');
                    
                    // Reload page after a short delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAlert('Failed to create and send prescription: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while creating and sending prescription.', 'danger');
            });
        });
    } else {
        console.error('Prescription form not found');
    }
});

// Set current filters from URL parameters
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    const type = urlParams.get('type');
    
    if (status) document.getElementById('status').value = status;
    if (type) document.getElementById('type').value = type;
});
</script>
{% endblock %}

{% block extra_css %}
<style>
    .glass-input {
        background: rgba(255, 255, 255, 0.1) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: white !important;
        backdrop-filter: blur(10px);
    }

    .glass-input:focus {
        background: rgba(255, 255, 255, 0.15) !important;
        border-color: rgba(102, 126, 234, 0.5) !important;
        box-shadow: 0 0 20px rgba(102, 126, 234, 0.3) !important;
    }

    .glass-input::placeholder {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    .form-floating > label {
        color: rgba(255, 255, 255, 0.8) !important;
    }

    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label {
        color: rgba(102, 126, 234, 0.8) !important;
    }

    .glass-alert {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }

    .table-dark {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        overflow: hidden;
    }

    .table-dark thead th {
        background: rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
    }

    .table-dark tbody tr {
        transition: all 0.3s ease;
    }

    .table-dark tbody tr:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .animate__fadeInUp {
        animation-duration: 0.8s;
    }

    .modal-content.bg-dark {
        backdrop-filter: blur(20px);
        background: rgba(33, 37, 41, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-group .btn {
        transition: all 0.3s ease;
    }

    .btn-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %} 